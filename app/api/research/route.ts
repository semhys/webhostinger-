import { NextRequest, NextResponse } from 'next/server';
import { Client } from '@elastic/elasticsearch';
import { analyzeWithAI, getAIUsageStats, validateOpenAIKey } from '@/lib/openai-service';

const client = new Client({
  node: process.env.ELASTICSEARCH_NODE!,
  auth: {
    apiKey: process.env.ELASTICSEARCH_API_KEY!
  }
});

// Configuraci√≥n especializada para investigaci√≥n t√©cnica interna
const RESEARCH_CONFIG = {
  // T√©rminos t√©cnicos especializados con pesos
  technical_terms: {
    'sistemas hidr√°ulicos': 3.0,
    'bombas centr√≠fugas': 2.8,
    'presi√≥n diferencial': 2.6,
    'caudal volum√©trico': 2.4,
    'eficiencia energ√©tica': 2.2,
    'automatizaci√≥n industrial': 2.0,
    'v√°lvulas de control': 1.8,
    'instrumentaci√≥n': 1.6,
    'mantenimiento predictivo': 1.4
  },
  
  // Categor√≠as de documentos t√©cnicos
  document_categories: [
    'hydraulic_systems', 'pump_analysis', 'flow_measurement',
    'pressure_control', 'automation', 'electrical_systems',
    'maintenance_reports', 'technical_specifications'
  ],
  
  // Tipos de an√°lisis disponibles
  analysis_types: {
    'equipos': 'An√°lisis de equipos y componentes',
    'rendimiento': 'An√°lisis de rendimiento y eficiencia', 
    'mantenimiento': 'An√°lisis de mantenimiento y diagn√≥stico',
    'especificaciones': 'B√∫squeda de especificaciones t√©cnicas',
    'comparativo': 'An√°lisis comparativo entre sistemas',
    'historial': 'Historial de proyectos similares'
  }
};

// Funci√≥n para an√°lisis inteligente de la consulta
function analyzeResearchQuery(query: string) {
  const lowercaseQuery = query.toLowerCase();
  
  // Detectar tipo de investigaci√≥n
  let research_type = 'general';
  if (lowercaseQuery.includes('bomba') || lowercaseQuery.includes('pump')) research_type = 'equipos';
  if (lowercaseQuery.includes('eficiencia') || lowercaseQuery.includes('rendimiento')) research_type = 'rendimiento';
  if (lowercaseQuery.includes('mantenimiento') || lowercaseQuery.includes('diagn√≥stico')) research_type = 'mantenimiento';
  if (lowercaseQuery.includes('especificaci√≥n') || lowercaseQuery.includes('datasheet')) research_type = 'especificaciones';
  if (lowercaseQuery.includes('comparar') || lowercaseQuery.includes('diferencia')) research_type = 'comparativo';
  if (lowercaseQuery.includes('proyecto') || lowercaseQuery.includes('anterior')) research_type = 'historial';
  
  // Extraer t√©rminos t√©cnicos clave
  const technical_terms = [];
  for (const [term, weight] of Object.entries(RESEARCH_CONFIG.technical_terms)) {
    if (lowercaseQuery.includes(term.toLowerCase())) {
      technical_terms.push({ term, weight });
    }
  }
  
  return { research_type, technical_terms };
}

// Funci√≥n de b√∫squeda especializada para investigaci√≥n
async function performResearchSearch(query: string, analysis: any) {
  try {
    const searchBody = {
      query: {
        bool: {
          should: [
            // B√∫squeda exacta en metadatos t√©cnicos
            {
              multi_match: {
                query: query,
                fields: [
                  'title^4.0',
                  'equipment_type^3.5', 
                  'specifications^3.0',
                  'technical_summary^2.8'
                ],
                type: 'phrase',
                boost: 4.0
              }
            },
            // B√∫squeda sem√°ntica en contenido t√©cnico
            {
              multi_match: {
                query: query,
                fields: [
                  'content^2.0',
                  'technical_data^2.5',
                  'analysis_results^2.2',
                  'conclusions^1.8'
                ],
                type: 'best_fields',
                fuzziness: 'AUTO',
                boost: 2.0
              }
            },
            // Boost por t√©rminos t√©cnicos detectados
            ...analysis.technical_terms.map(({term, weight}: any) => ({
              match: {
                content: {
                  query: term,
                  boost: weight
                }
              }
            }))
          ],
          // Filtros para documentos t√©cnicos relevantes
          filter: [
            {
              terms: {
                type: ['pdf', 'docx', 'xlsx', 'txt', 'doc']
              }
            },
            {
              range: {
                content_length: { gte: 100 } // Documentos con contenido sustancial
              }
            }
          ],
          minimum_should_match: 1
        }
      },
      // Resaltado avanzado para an√°lisis
      highlight: {
        fields: {
          content: {
            fragment_size: 300,
            number_of_fragments: 8,
            pre_tags: ['<mark class="highlight">'],
            post_tags: ['</mark>'],
            order: 'score'
          },
          title: {
            pre_tags: ['<strong class="title-match">'],
            post_tags: ['</strong>']
          }
        },
        max_analyzed_offset: 1000000
      },
      // Agregaciones para an√°lisis estad√≠stico
      aggs: {
        by_equipment_type: {
          terms: { field: 'equipment_type.keyword', size: 15 }
        },
        by_project_type: {
          terms: { field: 'project_type.keyword', size: 10 }
        },
        by_technical_category: {
          terms: { field: 'category.keyword', size: 20 }
        },
        content_analysis: {
          significant_text: {
            field: 'content',
            size: 10,
            min_doc_count: 2
          }
        }
      },
      size: 20, // M√°s resultados para an√°lisis profundo
      _source: {
        fields: [
          'title', 'content', 'filename', 'type', 'category',
          'equipment_type', 'project_type', 'technical_summary',
          'specifications', 'analysis_results', 'path', 'size',
          'extracted_metadata'
        ]
      },
      sort: [
        { _score: { order: 'desc' } }
      ]
    };

    const response = await client.search({
      index: 'semhys-documents',
      body: searchBody
    });

    return response;
    
  } catch (error) {
    console.error('Research search error:', error);
    throw error;
  }
}

// Funci√≥n para generar resumen de investigaci√≥n
function generateResearchSummary(results: any, analysis: any, query: string) {
  const total_docs = results.hits.total.value;
  const research_type_desc = RESEARCH_CONFIG.analysis_types[analysis.research_type] || 'An√°lisis general';
  
  let summary = `üî¨ **Investigaci√≥n SEMHYS**: ${research_type_desc}\n`;
  summary += `üìä **Documentos encontrados**: ${total_docs}\n`;
  summary += `üéØ **Consulta**: "${query}"\n\n`;
  
  if (analysis.technical_terms.length > 0) {
    summary += `üîß **T√©rminos t√©cnicos identificados**:\n`;
    analysis.technical_terms.forEach(({term, weight}: any) => {
      summary += `   ‚Ä¢ ${term} (relevancia: ${weight})\n`;
    });
    summary += '\n';
  }
  
  // Estad√≠sticas de agregaciones
  const aggs = results.aggregations;
  if (aggs?.by_equipment_type?.buckets?.length > 0) {
    summary += `‚öôÔ∏è **Tipos de equipos encontrados**:\n`;
    aggs.by_equipment_type.buckets.slice(0, 5).forEach((bucket: any) => {
      summary += `   ‚Ä¢ ${bucket.key}: ${bucket.doc_count} documentos\n`;
    });
    summary += '\n';
  }
  
  return summary;
}

export async function POST(request: NextRequest): Promise<NextResponse> {
  try {
    const { query, research_focus } = await request.json();

    if (!query || query.trim().length === 0) {
      return NextResponse.json({ 
        success: false,
        error: 'Consulta de investigaci√≥n requerida',
        suggestion: 'Ingresa t√©rminos t√©cnicos espec√≠ficos como: "bombas centr√≠fugas rendimiento", "sistema presi√≥n RCI", "mantenimiento equipos Tigo"'
      }, { status: 400 });
    }

    console.log(`üî¨ SEMHYS Research Agent - Consulta: "${query}"`);
    
    // An√°lisis inteligente de la consulta
    const analysis = analyzeResearchQuery(query);
    console.log(`üìä An√°lisis detectado: ${analysis.research_type}, t√©rminos t√©cnicos: ${analysis.technical_terms.length}`);

    const start_time = Date.now();
    
    // B√∫squeda especializada
    const searchResponse = await performResearchSearch(query, analysis);
    
    const search_time = Date.now() - start_time;
    const hits = searchResponse.body.hits;
    const total_found = hits.total.value;

    if (total_found === 0) {
      return NextResponse.json({
        success: true,
        results: [],
        total_found: 0,
        research_summary: `‚ùå **No se encontraron documentos t√©cnicos** para "${query}"\n\nüîç **Sugerencias**:\n‚Ä¢ Intenta t√©rminos m√°s espec√≠ficos\n‚Ä¢ Verifica ortograf√≠a t√©cnica\n‚Ä¢ Usa sin√≥nimos de equipos o procesos`,
        suggestions: [
          'Prueba con t√©rminos como: "bomba", "presi√≥n", "caudal", "RCI"',
          'Incluye nombres de proyectos espec√≠ficos',
          'Busca por tipos de equipos o marcas'
        ],
        search_time_ms: search_time,
        analysis_type: analysis.research_type
      });
    }

    // Procesar resultados para investigaci√≥n
    const research_results = hits.hits.map((hit: any, index: number) => {
      const source = hit._source;
      const highlights = hit.highlight || {};
      
      return {
        id: hit._id,
        rank: index + 1,
        title: source.title || source.filename,
        content_preview: source.content?.substring(0, 500) + '...',
        highlighted_content: highlights.content || [],
        highlighted_title: highlights.title?.[0] || source.title,
        document_type: source.type,
        category: source.category,
        equipment_type: source.equipment_type,
        project_type: source.project_type,
        technical_summary: source.technical_summary,
        filename: source.filename,
        file_size: source.size,
        path: source.path,
        timestamp: source['@timestamp'],
        relevance_score: hit._score,
        relevance_level: hit._score > 10 ? 'high' : hit._score > 5 ? 'medium' : 'low'
      };
    });

    // ü§ñ AN√ÅLISIS CON IA CHATGPT
    console.log('üß† Iniciando an√°lisis con IA...');
    const aiAnalysis = await analyzeWithAI(query, research_results, analysis.research_type);
    
    // Generar resumen combinado (Elasticsearch + IA)
    const research_summary = aiAnalysis.analysis || generateResearchSummary(searchResponse.body, analysis, query);

    // Sugerencias mejoradas con IA
    const suggestions = aiAnalysis.suggestions || [];
    const content_analysis = searchResponse.body.aggregations?.content_analysis?.buckets || [];
    if (content_analysis.length > 0) {
      suggestions.push('üìà **T√©rminos relacionados encontrados**:');
      content_analysis.slice(0, 3).forEach((term: any) => {
        suggestions.push(`‚Ä¢ "${term.key}" (${term.doc_count} documentos)`);
      });
    }

    return NextResponse.json({
      success: true,
      results: research_results,
      total_found,
      research_summary,
      
      // ü§ñ Nuevos campos con IA
      ai_analysis: {
        enabled: aiAnalysis.model_used !== 'none' && aiAnalysis.model_used !== 'error',
        analysis: aiAnalysis.analysis,
        model_used: aiAnalysis.model_used,
        cost_estimate: aiAnalysis.cost_estimate,
        tokens_used: aiAnalysis.tokens_used,
        confidence_score: aiAnalysis.confidence_score,
        suggestions: aiAnalysis.suggestions
      },
      
      analysis_type: analysis.research_type,
      technical_terms_detected: analysis.technical_terms,
      suggestions,
      search_time_ms: search_time,
      equipment_breakdown: searchResponse.body.aggregations?.by_equipment_type?.buckets || [],
      project_breakdown: searchResponse.body.aggregations?.by_project_type?.buckets || []
    });

  } catch (error) {
    console.error('üö® SEMHYS Research Agent Error:', error);
    
    return NextResponse.json({
      success: false,
      error: 'Error interno del agente de investigaci√≥n',
      technical_details: error instanceof Error ? error.message : 'Error desconocido',
      suggestion: 'Intenta reformular la consulta o contacta soporte t√©cnico'
    }, { status: 500 });
  }
}

// Endpoint GET para obtener estad√≠sticas del sistema
export async function GET(): Promise<NextResponse> {
  try {
    // Estad√≠sticas de la base de datos
    const stats = await client.indices.stats({ index: 'semhys-documents' });
    const health = await client.cluster.health();
    
    // ü§ñ Estad√≠sticas de IA
    const aiStats = await getAIUsageStats();
    const apiKeyValid = await validateOpenAIKey();
    
    return NextResponse.json({
      agent_status: 'active',
      elasticsearch_health: health.status,
      total_documents: stats._all?.total.docs.count || 0,
      index_size_mb: Math.round((stats._all?.total.store.size_in_bytes || 0) / 1024 / 1024),
      
      // ü§ñ Configuraci√≥n de IA
      ai_integration: {
        status: apiKeyValid ? 'active' : 'needs_configuration',
        current_model: aiStats.current_model,
        available_models: Object.keys(aiStats.model_config),
        monthly_cost_limit: aiStats.safety_limits.max_monthly_cost,
        api_configured: apiKeyValid
      },
      
      available_analysis_types: Object.entries(RESEARCH_CONFIG.analysis_types),
      technical_terms_catalog: Object.keys(RESEARCH_CONFIG.technical_terms).length,
      last_updated: new Date().toISOString()
    });
    
  } catch (error) {
    return NextResponse.json({
      agent_status: 'error',
      error: 'No se puede conectar con la base de datos de investigaci√≥n'
    }, { status: 500 });
  }
}