import { NextRequest, NextResponse } from 'next/server';

interface ChatMessage {
  message: string;
  language: 'en' | 'es' | 'pt';
  timestamp: string;
  sessionId: string;
}

export async function POST(request: NextRequest) {
  try {
    const chatData: ChatMessage = await request.json();
    const { message, language, timestamp, sessionId } = chatData;

    console.log(`üî¨ SEMHYS Chat ‚Üí N8N: "${message}"`);

    // Validaci√≥n b√°sica
    if (!message || message.trim().length === 0) {
      return NextResponse.json({
        success: false,
        error: 'Mensaje vac√≠o'
      }, { status: 400 });
    }

    // URL del webhook N8N para chat inteligente
    const n8nWebhookUrl = process.env.N8N_CHAT_WEBHOOK_URL;
    
    if (!n8nWebhookUrl) {
      console.error('‚ùå N8N_CHAT_WEBHOOK_URL no configurada');
      return NextResponse.json({
        success: true,
        response: language === 'es' 
          ? 'üîß Gracias por contactar SEMHYS. Nuestro equipo especializado te responder√° pronto.'
          : 'üîß Thank you for contacting SEMHYS. Our specialized team will respond soon.',
        category: 'general',
        priority: 'medium'
      });
    }

    try {
      console.log('üì° Enviando consulta a N8N...');
      
      // Enviar a N8N para procesamiento inteligente
      const n8nResponse = await fetch(n8nWebhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message.trim(),
          language: language || 'es',
          timestamp: timestamp || new Date().toISOString(),
          sessionId: sessionId || `chat-${Date.now()}`,
          source: 'semhys-chat-flotante'
        })
      });

      if (!n8nResponse.ok) {
        throw new Error(`N8N error: ${n8nResponse.status}`);
      }

      const n8nResult = await n8nResponse.json();
      console.log('‚úÖ N8N proces√≥ consulta:', n8nResult.category);

      return NextResponse.json({
        success: true,
        response: n8nResult.response || n8nResult.message || 'Consulta procesada correctamente.',
        category: n8nResult.category || 'general',
        priority: n8nResult.priority || 'medium',
        agent: n8nResult.agent || 'SEMHYS-N8N',
        timestamp: n8nResult.timestamp || new Date().toISOString()
      });

    } catch (n8nError) {
      console.error('‚ùå Error conectando con N8N:', n8nError);
      
      // Respuesta de fallback profesional
      const fallbackResponse = language === 'es' 
        ? 'üîß Hemos recibido tu consulta sobre ingenier√≠a. Nuestro equipo de especialistas de SEMHYS te contactar√° en las pr√≥ximas 2 horas para brindarte una soluci√≥n personalizada.'
        : 'üîß We have received your engineering inquiry. Our SEMHYS specialist team will contact you within the next 2 hours to provide a personalized solution.';

      return NextResponse.json({
        success: true,
        response: fallbackResponse,
        category: 'general',
        priority: 'medium',
        agent: 'SEMHYS-Local',
        timestamp: new Date().toISOString()
      });
    }

  } catch (error) {
    console.error('‚ùå SEMHYS Chat Error:', error);
    return NextResponse.json({
      success: false,
      error: 'Error procesando consulta'
    }, { status: 500 });
  }
}